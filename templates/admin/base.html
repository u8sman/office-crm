{% extends 'unfold/layouts/skeleton.html' %}

{% load static admin_list i18n unfold %}

{% block base %}

    {# ================= LOADER OVERLAY ================= #}
    <div
        id="htmx-loader"
        class="fixed inset-0 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200"
        style="z-index: 99999;"
    >
        <div class="loader-wrapper">
            <span class="loader-letter">L</span>
            <span class="loader-letter">o</span>
            <span class="loader-letter">a</span>
            <span class="loader-letter">d</span>
            <span class="loader-letter">i</span>
            <span class="loader-letter">n</span>
            <span class="loader-letter">g</span>
            <span class="loader-letter">.</span>
            <span class="loader-letter">.</span>
            <span class="loader-letter">.</span>

            <div class="loader"></div>
        </div>
    </div>

    <style>
        /* ================= Overlay (transparent dark) ================= */

        #htmx-loader {
            background: rgba(30, 41, 59, 0.80);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }

        .dark #htmx-loader {
            background: rgba(15, 23, 42, 0.80);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }

        /* ================= Loader core ================= */

        .loader-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 180px;
            height: 180px;
            font-family: "Inter", system-ui, sans-serif;
            font-size: 1.1em;
            font-weight: 400;
            color: #f9fafb;
            border-radius: 50%;
            user-select: none;
        }

        .loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            animation: loader-rotate 2s linear infinite;
            animation-play-state: paused;
            z-index: 0;
        }

        @keyframes loader-rotate {
            0% {
                transform: rotate(90deg);
                box-shadow:
                    0 10px 20px 0 #fff inset,
                    0 20px 30px 0 #ad5fff inset,
                    0 60px 60px 0 #471eec inset;
            }
            50% {
                transform: rotate(270deg);
                box-shadow:
                    0 10px 20px 0 #fff inset,
                    0 20px 10px 0 #d60a47 inset,
                    0 40px 60px 0 #311e80 inset;
            }
            100% {
                transform: rotate(450deg);
                box-shadow:
                    0 10px 20px 0 #fff inset,
                    0 20px 30px 0 #ad5fff inset,
                    0 60px 60px 0 #471eec inset;
            }
        }

        .loader-letter {
            display: inline-block;
            opacity: 0.4;
            transform: translateY(0);
            animation: loader-letter-anim 2s infinite;
            animation-play-state: paused;
            z-index: 1;
            margin: 0 1px;
        }

        .loader-letter:nth-child(1)  { animation-delay: 0s; }
        .loader-letter:nth-child(2)  { animation-delay: 0.1s; }
        .loader-letter:nth-child(3)  { animation-delay: 0.2s; }
        .loader-letter:nth-child(4)  { animation-delay: 0.3s; }
        .loader-letter:nth-child(5)  { animation-delay: 0.4s; }
        .loader-letter:nth-child(6)  { animation-delay: 0.5s; }
        .loader-letter:nth-child(7)  { animation-delay: 0.6s; }
        .loader-letter:nth-child(8)  { animation-delay: 0.7s; }
        .loader-letter:nth-child(9)  { animation-delay: 0.8s; }
        .loader-letter:nth-child(10) { animation-delay: 0.9s; }

        @keyframes loader-letter-anim {
            0%, 100% { opacity: 0.4; transform: translateY(0); }
            20%      { opacity: 1;   transform: scale(1.15); }
            40%      { opacity: 0.7; transform: translateY(0); }
        }

        #htmx-loader.htmx-request {
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        #htmx-loader.htmx-request .loader,
        #htmx-loader.htmx-request .loader-letter {
            animation-play-state: running;
        }
    </style>

    {# ================= SPA WRAPPER ================= #}
    <div
        id="page"
        class="flex max-w-full min-h-screen {% element_classes 'page' %}"
        {# IMPORTANT: only SPA-boost on changelists (cl), not change forms (opts only) #}
        {% if not is_popup and cl %}
            hx-boost="true"
            hx-target="#main"
            hx-select="#main"
            hx-push-url="true"
            hx-indicator="#htmx-loader"
        {% endif %}
    >
        {% if not is_popup and is_nav_sidebar_enabled %}
            {% block nav-sidebar %}
                {% include "admin/nav_sidebar.html" %}
            {% endblock %}
        {% endif %}

        <div id="main" class="bg-white flex flex-col grow min-w-0 dark:bg-base-900 {% element_classes 'main' %}">

            {% include "unfold/helpers/header.html" %}

            {% block messages %}
                <div class="px-4">
                    <div id="messages-container" class="mx-auto {% if not cl.model_admin.list_fullwidth %}container{% endif %}">
                        {% include "unfold/helpers/messages.html" %}
                    </div>
                </div>
            {% endblock messages %}

            <div class="@container px-4 pb-4 grow">
                <div id="content"
                     class="{% if not cl.model_admin.list_fullwidth %}container{% endif %} mx-auto {% block coltype %}colM{% endblock %}">
                    {% if cl %}
                        {% tab_list "changelist" cl.opts %}
                    {% elif opts %}
                        {% tab_list "changeform" opts %}
                    {% endif %}

                    {% block content %}
                        {% block object-tools %}{% endblock %}
                        {{ content }}
                    {% endblock content %}

                    {% block sidebar %}{% endblock %}
                </div>
            </div>

            {% block footer %}{% endblock %}
        </div>
    </div>

    {# ================= SCRIPTS ================= #}

    <script>
        function getCookie(name) {
            const value = "; " + document.cookie;
            const parts = value.split("; " + name + "=");
            return parts.length === 2 ? parts.pop().split(";").shift() : null;
        }

        document.body.addEventListener("htmx:configRequest", function (event) {
            const method = (event.detail.verb || "GET").toUpperCase();
            if (method !== "GET" && method !== "HEAD") {
                const csrftoken = getCookie("csrftoken");
                if (csrftoken) {
                    event.detail.headers["X-CSRFToken"] = csrftoken;
                }
            }
        });

        document.body.addEventListener("htmx:responseError", function (event) {
            const xhr = event.detail.xhr || {};
            const status = xhr.status || "";
            const statusText = xhr.statusText || "";

            let detail = "";

            if (event.detail.error) {
                detail += `HTMX Signal: ${event.detail.error}\n\n`;
            }

            if (xhr.responseText) {
                let txt = xhr.responseText.replace(/<[^>]+>/g, " ").trim();
                if (txt.length > 400) txt = txt.slice(0, 400) + "...";
                detail += `Response:\n${txt}\n\n`;
            }

            if (status) {
                detail += `HTTP Status: ${status} ${statusText}\n`;
            }

            alert(
`⚠️ Error while loading page

${detail || "No additional information available."}`
            );
        });
    </script>

    <script>
        // External links in new tab
        document.addEventListener("click", function (e) {
            const a = e.target.closest("a");
            if (!a) return;

            // Let middle-click / modifier-click behave normally
            if (e.button !== 0 || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

            if (a.target === "_blank") return;

            // Ignore HTMX / SPA-handled links
            if (
                a.hasAttribute("hx-get") ||
                a.hasAttribute("hx-post") ||
                a.hasAttribute("hx-patch") ||
                a.hasAttribute("hx-put") ||
                a.hasAttribute("hx-delete") ||
                a.getAttribute("hx-boost") === "true"
            ) {
                return;
            }

            const href = a.getAttribute("href") || "";

            // Ignore anchors, mailto, tel, javascript: links
            if (
                href.startsWith("#") ||
                href.startsWith("mailto:") ||
                href.startsWith("tel:") ||
                href.startsWith("javascript:")
            ) {
                return;
            }

            let url;
            try {
                url = new URL(href, window.location.origin);
            } catch (err) {
                return; // invalid URL – let browser handle
            }

            const isExternal = url.origin !== window.location.origin;

            if (isExternal) {
                e.preventDefault();
                window.open(url.href, "_blank", "noopener,noreferrer");
            }
        });
    </script>

    <script>
        // Sidebar active state
        (function () {
            const ACTIVE_CLASSES = [
                "bg-base-100",
                "font-semibold",
                "text-primary-600",
                "dark:bg-white/[.06]",
                "dark:text-primary-500",
            ];

            function normalizePath(href) {
                try {
                    const url = new URL(href, window.location.origin);
                    let path = url.pathname || "/";
                    path = path.replace(/\/+$/, "");
                    if (path === "") path = "/";
                    return path;
                } catch (e) {
                    return href;
                }
            }

            function updateNavActive() {
                const nav = document.getElementById("nav-sidebar");
                if (!nav) return;

                const currentPath = normalizePath(window.location.href);
                const links = nav.querySelectorAll("a[href]");
                let bestLink = null;
                let bestLen = -1;

                links.forEach(function (a) {
                    const hrefPath = normalizePath(a.href);
                    const isMatch =
                        currentPath === hrefPath ||
                        currentPath.startsWith(hrefPath + "/");

                    if (isMatch && hrefPath.length > bestLen) {
                        bestLen = hrefPath.length;
                        bestLink = a;
                    }
                });

                links.forEach(function (a) {
                    ACTIVE_CLASSES.forEach(function (cls) {
                        a.classList.remove(cls);
                    });
                });

                if (bestLink) {
                    ACTIVE_CLASSES.forEach(function (cls) {
                        bestLink.classList.add(cls);
                    });
                }
            }

            document.addEventListener("DOMContentLoaded", updateNavActive);

            document.body.addEventListener("htmx:afterSwap", function (event) {
                const t = event.detail && event.detail.target;
                if (t && t.id === "main") {
                    updateNavActive();

                    // Re-init Alpine/Unfold on the swapped content
                    if (window.Alpine && typeof window.Alpine.initTree === "function") {
                        window.Alpine.initTree(t);
                    }
                }
            });

            window.addEventListener("popstate", updateNavActive);
        })();
    </script>

    {# ==== IMPORTANT: disable HTMX boost on Django popup links ==== #}
    <script>
        (function () {
            function markPopupLinks(root) {
                const container = root || document;
                const links = container.querySelectorAll('a[href*="_popup=1"]');
                links.forEach(function (a) {
                    // Disable htmx boost on popup links so Django's popup JS works
                    a.setAttribute("hx-boost", "false");
                });
            }

            document.addEventListener("DOMContentLoaded", function () {
                markPopupLinks(document);
            });

            document.body.addEventListener("htmx:afterSwap", function (event) {
                // Re-apply to any new content swapped into the page
                markPopupLinks(event.target || document);
            });
        })();
    </script>

    <script>
    (function () {
        // Generic SPA navigation helper
        function spaNavigate(url) {
            let urlObj;
            try {
                urlObj = new URL(url, window.location.origin);
            } catch (e) {
                // Fallback if URL is weird
                window.location.href = url;
                return;
            }

            const pathname = urlObj.pathname || "";

            // IMPORTANT:
            // For admin *forms* (add/change/delete), we force a full page load
            // so Django inlines & Unfold behave normally.
            const isAdmin = pathname.startsWith("/admin/");
            const isFormLike =
                pathname.includes("/add/") ||
                /\/\d+\/(change|delete)?\/?$/.test(pathname);

            if (isAdmin && isFormLike) {
                window.location.href = urlObj.href;
                return;
            }

            const loader = document.getElementById("htmx-loader");

            // Show fullscreen loader ONLY for SPA navigations
            if (loader) {
                loader.classList.add("htmx-request");
            }

            if (typeof htmx !== "undefined" && htmx.ajax) {
                // Remove loader when this specific swap finishes or errors
                function clearLoaderOnce() {
                    if (loader) {
                        loader.classList.remove("htmx-request");
                    }
                    document.body.removeEventListener("htmx:afterSwap", clearLoaderOnce);
                    document.body.removeEventListener("htmx:responseError", clearLoaderOnce);
                }

                document.body.addEventListener("htmx:afterSwap", clearLoaderOnce);
                document.body.addEventListener("htmx:responseError", clearLoaderOnce);

                htmx.ajax("GET", urlObj.href, {
                    target: "#main",
                    select: "#main",
                    swap: "innerHTML",
                    pushUrl: true
                });
            } else {
                // Fallback: full page navigation (browser handles loading)
                window.location.href = urlObj.href;
            }
        }

        // Helper: close Unfold command palette modal & backdrop
        function closeCommandPalette() {
            // 1) Let Alpine/Unfold do its normal ESC handling
            document.dispatchEvent(
                new KeyboardEvent("keydown", {
                    key: "Escape",
                    code: "Escape",
                    keyCode: 27,
                    which: 27,
                    bubbles: true
                })
            );

            // 2) Force-hide the Alpine root that has the backdrop + modal
            setTimeout(function () {
                // Your wrapper: <div x-data="searchCommand()" x-show="openCommandResults" ...>
                const commandRoot = document.querySelector('[x-data="searchCommand()"]');
                if (commandRoot) {
                    commandRoot.classList.add("hidden");
                    commandRoot.style.display = "none";
                }

                // Inner white card (just in case)
                const input = document.getElementById("search-input-command");
                if (input) {
                    const modalCard = input.closest(".bg-white");
                    if (modalCard) {
                        modalCard.classList.add("hidden");
                        modalCard.style.display = "none";
                    }
                }
            }, 0);
        }

        // Expose in case you want to call it elsewhere
        window.closeCommandPalette = closeCommandPalette;

        // 1) Override Unfold's sidebar search dropdown with SPA-aware version
        window.searchDropdown = function () {
            return {
                openSearchResults: false,
                currentIndex: 0,

                applyShortcut(event) {
                    // ignore when typing in inputs/textareas/contentEditable
                    const target = event.target;
                    const tag = target.tagName ? target.tagName.toLowerCase() : "";
                    if (tag === "input" || tag === "textarea" || target.isContentEditable) {
                        return;
                    }

                    // same idea as Unfold: focus search on "t"
                    if (event.key === "t" && !event.ctrlKey && !event.metaKey && !event.altKey) {
                        event.preventDefault();
                        const input = document.getElementById("nav-filter");
                        if (input) {
                            input.focus();
                            this.openSearchResults = true;
                            this.currentIndex = 0;
                        }
                    }
                },

                nextItem() {
                    const items = this._getItems();
                    if (!items.length) return;
                    this.currentIndex = (this.currentIndex + 1) % items.length;
                },

                prevItem() {
                    const items = this._getItems();
                    if (!items.length) return;
                    this.currentIndex = (this.currentIndex - 1 + items.length) % items.length;
                },

                _getItems() {
                    const nodes = document.querySelectorAll("#search-results a[href]");
                    return Array.from(nodes);
                },

                selectItem() {
                    const items = this._getItems();
                    if (!items.length) return;

                    let index = this.currentIndex;
                    if (index < 0 || index >= items.length) {
                        index = 0;
                    }

                    const link = items[index];
                    const url = link.href;

                    this.openSearchResults = false;
                    spaNavigate(url);
                }
            };
        };

        // 2) Global SPA handler for command palette click
        window.__spaCommandClick = function (url, addHistory) {
            // Always treat the URL as a normal SPA navigation helper,
            // but spaNavigate will decide if it should be full load.
            closeCommandPalette();
            spaNavigate(url);
        };
    })();
    </script>

{% endblock %}
