{% extends 'unfold/layouts/skeleton.html' %}

{% load static admin_list i18n unfold %}

{% block base %}

    {# ================= LOADER OVERLAY ================= #}
    <div
        id="htmx-loader"
        class="fixed inset-0 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200"
        style="z-index: 99999;"
    >
        <div class="loader-wrapper">
            <span class="loader-letter">L</span>
            <span class="loader-letter">o</span>
            <span class="loader-letter">a</span>
            <span class="loader-letter">d</span>
            <span class="loader-letter">i</span>
            <span class="loader-letter">n</span>
            <span class="loader-letter">g</span>
            <span class="loader-letter">.</span>
            <span class="loader-letter">.</span>
            <span class="loader-letter">.</span>

            <div class="loader"></div>
        </div>
    </div>

    <style>
        /* ================= Overlay (transparent dark) ================= */

        #htmx-loader {
            background: rgba(30, 41, 59, 0.80);   /* base-900/80 */
            backdrop-filter: blur(2px);          /* blur-xs */
            -webkit-backdrop-filter: blur(2px);
        }

        .dark #htmx-loader {
            background: rgba(15, 23, 42, 0.80);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }

        /* ================= Loader core ================= */

        .loader-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 180px;
            height: 180px;
            font-family: "Inter", system-ui, sans-serif;
            font-size: 1.1em;
            font-weight: 400;
            color: #f9fafb;
            border-radius: 50%;
            user-select: none;
        }

        .loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            animation: loader-rotate 2s linear infinite;
            animation-play-state: paused;     /* PAUSED until request happens */
            z-index: 0;
        }

        @keyframes loader-rotate {
            0% {
                transform: rotate(90deg);
                box-shadow:
                    0 10px 20px 0 #fff inset,
                    0 20px 30px 0 #ad5fff inset,
                    0 60px 60px 0 #471eec inset;
            }
            50% {
                transform: rotate(270deg);
                box-shadow:
                    0 10px 20px 0 #fff inset,
                    0 20px 10px 0 #d60a47 inset,
                    0 40px 60px 0 #311e80 inset;
            }
            100% {
                transform: rotate(450deg);
                box-shadow:
                    0 10px 20px 0 #fff inset,
                    0 20px 30px 0 #ad5fff inset,
                    0 60px 60px 0 #471eec inset;
            }
        }

        .loader-letter {
            display: inline-block;
            opacity: 0.4;
            transform: translateY(0);
            animation: loader-letter-anim 2s infinite;
            animation-play-state: paused;   /* PAUSED until request happens */
            z-index: 1;
            margin: 0 1px;
        }

        .loader-letter:nth-child(1)  { animation-delay: 0s; }
        .loader-letter:nth-child(2)  { animation-delay: 0.1s; }
        .loader-letter:nth-child(3)  { animation-delay: 0.2s; }
        .loader-letter:nth-child(4)  { animation-delay: 0.3s; }
        .loader-letter:nth-child(5)  { animation-delay: 0.4s; }
        .loader-letter:nth-child(6)  { animation-delay: 0.5s; }
        .loader-letter:nth-child(7)  { animation-delay: 0.6s; }
        .loader-letter:nth-child(8)  { animation-delay: 0.7s; }
        .loader-letter:nth-child(9)  { animation-delay: 0.8s; }
        .loader-letter:nth-child(10) { animation-delay: 0.9s; }

        @keyframes loader-letter-anim {
            0%, 100% { opacity: 0.4; transform: translateY(0); }
            20%      { opacity: 1;   transform: scale(1.15); }
            40%      { opacity: 0.7; transform: translateY(0); }
        }

        /* ================= HTMX triggers loader ================= */

        #htmx-loader.htmx-request {
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        #htmx-loader.htmx-request .loader,
        #htmx-loader.htmx-request .loader-letter {
            animation-play-state: running;
        }
    </style>

    {# ================= SPA WRAPPER ================= #}
    <div
        id="page"
        class="flex max-w-full min-h-screen {% element_classes 'page' %}"
        hx-boost="true"
        hx-target="#content"
        hx-select="#content"
        hx-push-url="true"
        hx-indicator="#htmx-loader"
    >
        {% if not is_popup and is_nav_sidebar_enabled %}
            {% block nav-sidebar %}
                {% include "admin/nav_sidebar.html" %}
            {% endblock %}
        {% endif %}

        <div id="main" class="bg-white flex flex-col grow min-w-0 dark:bg-base-900 {% element_classes 'main' %}">

            {% include "unfold/helpers/header.html" %}

            {# messages block #}
            {% block messages %}
                <div class="px-4">
                    <div id="messages-container" class="mx-auto {% if not cl.model_admin.list_fullwidth %}container{% endif %}">
                        {% include "unfold/helpers/messages.html" %}
                    </div>
                </div>
            {% endblock messages %}

            <div class="@container px-4 pb-4 grow">
                <div id="content"
                     class="{% if not cl.model_admin.list_fullwidth %}container{% endif %} mx-auto {% block coltype %}colM{% endblock %}">
                    {% if cl %}
                        {% tab_list "changelist" cl.opts %}
                    {% elif opts %}
                        {% tab_list "changeform" opts %}
                    {% endif %}

                    {% block content %}
                        {% block object-tools %}{% endblock %}
                        {{ content }}
                    {% endblock content %}

                    {% block sidebar %}{% endblock %}
                </div>
            </div>

            {% block footer %}{% endblock %}
        </div>
    </div>

    {# ================= SCRIPTS ================= #}

    <script>
        /* CSRF helper */
        function getCookie(name) {
            const value = "; " + document.cookie;
            const parts = value.split("; " + name + "=");
            return parts.length === 2 ? parts.pop().split(";").shift() : null;
        }

        /* Attach CSRF to HTMX POST/PUT/DELETE */
        document.body.addEventListener("htmx:configRequest", function (event) {
            const method = (event.detail.verb || "GET").toUpperCase();
            if (method !== "GET" && method !== "HEAD") {
                const csrftoken = getCookie("csrftoken");
                if (csrftoken) {
                    event.detail.headers["X-CSRFToken"] = csrftoken;
                }
            }
        });

        /* Only alert-based error handling — no Django messages */
        document.body.addEventListener("htmx:responseError", function (event) {

            const xhr = event.detail.xhr || {};
            const status = xhr.status || "";
            const statusText = xhr.statusText || "";

            let detail = "";

            if (event.detail.error) {
                detail += `HTMX Signal: ${event.detail.error}\n\n`;
            }

            if (xhr.responseText) {
                let txt = xhr.responseText.replace(/<[^>]+>/g, " ").trim();
                if (txt.length > 400) txt = txt.slice(0, 400) + "...";
                detail += `Response:\n${txt}\n\n`;
            }

            if (status) {
                detail += `HTTP Status: ${status} ${statusText}\n`;
            }

            alert(
`⚠️ Error while loading page

${detail || "No additional information available."}`
            );
        });

    </script>

    <script>
    // Make all EXTERNAL links open in a new tab
    document.addEventListener("click", function (e) {
        const a = e.target.closest("a");
        if (!a) return;

        // Ignore if already set to open in new tab
        if (a.target === "_blank") return;

        // Ignore htmx boosted or specific admin links
        if (a.hasAttribute("hx-get") ||
            a.hasAttribute("hx-post") ||
            a.hasAttribute("hx-patch") ||
            a.hasAttribute("hx-put") ||
            a.hasAttribute("hx-delete") ||
            a.getAttribute("hx-boost") === "true"
        ) {
            return;
        }

        // Build absolute URL for comparison
        const url = new URL(a.href, window.location.origin);

        // Check if the link domain matches current domain
        const isExternal = url.origin !== window.location.origin;

        if (isExternal) {
            e.preventDefault();
            window.open(url.href, "_blank", "noopener,noreferrer");
        }
    });
</script>


{% endblock %}
